---
import siteConfig from '../content/site.json';

const allEvents = await Astro.glob('../content/events/*.md');
const sortedEvents = allEvents
  .filter((e) => !e.frontmatter.draft)
  .sort((a, b) => new Date(b.frontmatter.date).getTime() - new Date(a.frontmatter.date).getTime());

// Build YAML navigation HTML
const eventsNav = sortedEvents.map((e) => 
  `      - <a href="#event-${e.frontmatter.number}" class="text-cream/70 hover:text-accent transition-colors">${String(e.frontmatter.number).padStart(3, '0')}</a>`
).join('\n');

const socialLink = (key: string, url: string) => 
  url 
    ? `<a href="${url}" target="_blank" class="text-cream hover:text-accent transition-colors">${url}</a>`
    : `<span class="text-cream/30">~</span>`;

const yamlNav = `<span class="text-cream/50"># ${siteConfig.name}</span>
<span class="text-cream/50">---</span>

<span class="text-accent">site</span><span class="text-cream/50">:</span>
  <span class="text-blue-gray">name</span><span class="text-cream/50">:</span> <span class="text-cream">"${siteConfig.name}"</span>
  <span class="text-blue-gray">tagline</span><span class="text-cream/50">:</span> <span class="text-cream">"${siteConfig.tagline || '~'}"</span>

<span class="text-accent">navigation</span><span class="text-cream/50">:</span>
  - <a href="#home" class="text-cream hover:text-accent transition-colors">home</a>
  - <a href="#events" class="text-cream hover:text-accent transition-colors">events</a><span class="text-cream/50">:</span>
${eventsNav}
  - <a href="#contact" class="text-cream hover:text-accent transition-colors">contact</a>

<span class="text-accent">socials</span><span class="text-cream/50">:</span>
  <span class="text-blue-gray">meetup</span><span class="text-cream/50">:</span> ${socialLink('meetup', siteConfig.socials.meetup)}
  <span class="text-blue-gray">discord</span><span class="text-cream/50">:</span> ${socialLink('discord', siteConfig.socials.discord)}
  <span class="text-blue-gray">linkedin</span><span class="text-cream/50">:</span> ${socialLink('linkedin', siteConfig.socials.linkedin)}
  <span class="text-blue-gray">github</span><span class="text-cream/50">:</span> ${socialLink('github', siteConfig.socials.github)}`;
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content={siteConfig.description || siteConfig.name} />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <title>{siteConfig.name}</title>
  </head>
  <body class="bg-primary text-cream font-mono">
    <div class="flex h-screen">
      
      <!-- Left Panel: YAML Navigation -->
      <nav class="w-1/2 h-screen overflow-auto p-8 border-r border-cream/20 flex flex-col">
        <pre class="text-sm leading-relaxed flex-1" set:html={yamlNav} />
      </nav>

      <!-- Right Panel: Content -->
      <main class="w-1/2 h-screen overflow-auto scroll-smooth">
        
        <!-- Home Section -->
        <section id="home" class="min-h-screen p-8 flex flex-col justify-center border-b border-cream/10">
          <h1 class="text-4xl font-bold mb-4">
            {siteConfig.name}
          </h1>
          {siteConfig.tagline && (
            <p class="text-xl text-cream/70 mb-6">{siteConfig.tagline}</p>
          )}
          {siteConfig.description && (
            <p class="text-cream/60 max-w-lg">{siteConfig.description}</p>
          )}
        </section>

        <!-- Events Section -->
        <section id="events" class="min-h-screen p-8 border-b border-cream/10">
          <h2 class="text-2xl font-bold mb-8 text-accent">Events</h2>
          
          {sortedEvents.length === 0 ? (
            <p class="text-cream/50">No events yet.</p>
          ) : (
            <div class="space-y-12">
              {sortedEvents.map((event) => (
                <article id={`event-${event.frontmatter.number}`} class="border-l-2 border-accent/30 pl-6">
                  <div class="text-cream/50 text-sm mb-1">#{String(event.frontmatter.number).padStart(3, '0')}</div>
                  <h3 class="text-xl font-bold mb-2">{event.frontmatter.title}</h3>
                  <div class="text-sm text-cream/60 mb-4">
                    <span>{new Date(event.frontmatter.date).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' })}</span>
                    {event.frontmatter.location && (
                      <span> · {event.frontmatter.location}</span>
                    )}
                  </div>
                  {event.frontmatter.description && (
                    <p class="text-cream/70 mb-4">{event.frontmatter.description}</p>
                  )}
                  {event.frontmatter.talks && event.frontmatter.talks.length > 0 && (
                    <div class="mt-4">
                      <div class="text-sm text-accent mb-2">Talks:</div>
                      <ul class="space-y-3">
                        {event.frontmatter.talks.map((talk: any) => (
                          <li class="text-sm pl-4 border-l border-cream/20">
                            <div class="font-semibold">{talk.title}</div>
                            {talk.speakers && (
                              <div class="text-cream/50">
                                by {talk.speakers.map((s: any) => s.name).join(', ')}
                              </div>
                            )}
                          </li>
                        ))}
                      </ul>
                    </div>
                  )}
                  {event.frontmatter.meetupUrl && (
                    <a href={event.frontmatter.meetupUrl} target="_blank" rel="noopener noreferrer" class="inline-block mt-4 text-sm text-accent hover:text-cream transition-colors">
                      View on Meetup →
                    </a>
                  )}
                </article>
              ))}
            </div>
          )}
        </section>

        <!-- Contact Section -->
        <section id="contact" class="min-h-screen p-8 flex flex-col justify-center">
          <h2 class="text-2xl font-bold mb-8 text-accent">Contact</h2>
          
          <div class="space-y-4 text-cream/70">
            {siteConfig.email && (
              <p>
                <span class="text-cream/50">email:</span>{" "}
                <a href={`mailto:${siteConfig.email}`} class="hover:text-accent transition-colors">{siteConfig.email}</a>
              </p>
            )}
            {siteConfig.socials.meetup && (
              <p>
                <span class="text-cream/50">meetup:</span>{" "}
                <a href={siteConfig.socials.meetup} target="_blank" rel="noopener noreferrer" class="hover:text-accent transition-colors">{siteConfig.socials.meetup}</a>
              </p>
            )}
            {siteConfig.socials.discord && (
              <p>
                <span class="text-cream/50">discord:</span>{" "}
                <a href={siteConfig.socials.discord} target="_blank" rel="noopener noreferrer" class="hover:text-accent transition-colors">{siteConfig.socials.discord}</a>
              </p>
            )}
            {siteConfig.socials.linkedin && (
              <p>
                <span class="text-cream/50">linkedin:</span>{" "}
                <a href={siteConfig.socials.linkedin} target="_blank" rel="noopener noreferrer" class="hover:text-accent transition-colors">{siteConfig.socials.linkedin}</a>
              </p>
            )}
            {siteConfig.socials.github && (
              <p>
                <span class="text-cream/50">github:</span>{" "}
                <a href={siteConfig.socials.github} target="_blank" rel="noopener noreferrer" class="hover:text-accent transition-colors">{siteConfig.socials.github}</a>
              </p>
            )}
          </div>

          {!siteConfig.email && Object.values(siteConfig.socials).every(v => !v) && (
            <p class="text-cream/50">No contact information yet.</p>
          )}
        </section>

      </main>
    </div>
  </body>
</html>
